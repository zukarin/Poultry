;/*FB_PKG_DELIM*/

__d("EbFetchTimeoutMsForMLv2",["DateConsts","gkx","qex"],(function(a,b,c,d,e,f,g){"use strict";var h=10,i=15,j=!c("gkx")("6581");function a(a){return k(a)*d("DateConsts").MS_PER_SEC}function k(a){return j?h:(a=l(a))!=null?a:i}function l(a){switch(a){case"exposure_logging_disabled":return c("qex")._("464");case"exposure_logging_enabled":return c("qex")._("229");default:a;return null}}g["default"]=a}),98);
__d("MAWQPLLogger",["QPLUserFlow","Random","cr:10049"],(function(a,b,c,d,e,f,g){"use strict";b("cr:10049")==null?void 0:b("cr:10049").overwriteSamplingRate();function a(a){return{addQPLAnnotations:function(b,d){c("QPLUserFlow").addAnnotations(a,d,{instanceKey:b})},markQPLCancel:function(b){c("QPLUserFlow").endCancel(a,{instanceKey:b})},markQPLFailure:function(b,d){var e;c("QPLUserFlow").endFailure(a,(e=d==null?void 0:d.name)!=null?e:"fail",{error:d,instanceKey:b})},markQPLFailureWithMsg:function(b,d){c("QPLUserFlow").endFailure(a,d,{instanceKey:b})},markQPLPoint:function(b,d,e){c("QPLUserFlow").addPoint(a,d,{debugInfo:e,instanceKey:b})},markQPLStart:function(){var b=Date.now()+(Math.round(d("Random").random()*1e4)+1e4);c("QPLUserFlow").start(a,{instanceKey:b});return b},markQPLSuccess:function(b){c("QPLUserFlow").endSuccess(a,{instanceKey:b})}}}g["default"]=a}),98);
__d("MAWDataSourceLogger",["I64","MAWQPLLogger","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){i==null&&(i=c("MAWQPLLogger")(c("qpl")._(25303796,"1974")));return i}function a(a){var b=j().markQPLStart();j().addQPLAnnotations(b,{string:{threadType:(h||(h=d("I64"))).to_string(a)}});return b}function b(a,b,c){j().markQPLPoint(a,"wait_act_thread_start","before fetching messages range from table"),j().addQPLAnnotations(a,{"int":{version:1},string:{direction:b,thread_id:(h||(h=d("I64"))).to_string(c)}})}function e(a,b){j().markQPLFailureWithMsg(a,b)}function f(a){j().markQPLCancel(a)}function k(a){j().markQPLPoint(a,"wait_act_thread_end","before fetching messages range from table"),j().markQPLPoint(a,"load_more_msgs_start","load more messages from MAW DB")}function l(a){j().markQPLPoint(a,"load_messages_from_eb_start","load more messages from EB")}function m(a){j().markQPLPoint(a,"load_messages_from_eb_end","load more messages from EB")}function n(a){j().markQPLPoint(a,"load_messages_from_local_db_start")}function o(a){j().markQPLPoint(a,"load_messages_from_local_db_end")}function p(a){j().markQPLPoint(a,"insert_msgs_to_lsdb_start")}function q(a){j().markQPLPoint(a,"insert_msgs_to_lsdb_end")}function r(a){j().markQPLPoint(a,"insert_msgs_to_lsdb_dispatch_download_state_updates_start")}function s(a){j().markQPLPoint(a,"insert_msgs_to_lsdb_dispatch_download_state_updates_end")}function t(a){j().markQPLPoint(a,"insert_msgs_to_lsdb_call_bridge_handlers_start")}function u(a){j().markQPLPoint(a,"insert_msgs_to_lsdb_call_bridge_handlers_end")}function v(a,b){j().markQPLPoint(a,"load_more_msgs_end","Note: OLD SOLUTION DOES NOT FETCH messages. they are fetched in afterTransaction that we cannot control"),j().addQPLAnnotations(a,{bool:{hasMoreBefore:b}})}function w(a){j().markQPLSuccess(a)}function x(a,b){j().markQPLPoint(a,"issued_range_query","MAWFetchSecureMessages: minMsgSortOrderTsResponse "+b)}function y(a,b){j().markQPLFailure(a,b)}g.logLoadMoreMsgsStart=a;g.logLoadMoreMsgsThreadWaiting=b;g.logLoadMoreMsgsFailure=e;g.logLoadMoreMsgsCancel=f;g.logLoadMoreMsgsThreadReadyFetchMsgs=k;g.logLoadMessagesFromEBStart=l;g.logLoadMessagesFromEBEnd=m;g.logLoadMessagesFromLocalDBStart=n;g.logLoadMessagesFromLocalDBEnd=o;g.logInsertMessageResponseToLSDBStart=p;g.logInsertMessageResponseToLSDBEnd=q;g.logDispatchDownloadStateUpdatesStart=r;g.logDispatchDownloadStateUpdatesEnd=s;g.logCallBridgeHandlersStart=t;g.logCallBridgeHandlersEnd=u;g.logLoadMoreMsgsFetched=v;g.logLoadMoreMsgsSuccess=w;g.logLoadMoreMsgsRangeQuery=x;g.logLoadMoreMsgsRuntimeError=y}),98);
__d("MAWEBMsgsWithSameSortOrderFix",["MAWMessagesCompare","MAWMessagesDirection","gkx","justknobx"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){if(b==null||!c("gkx")("7950"))return a;b=c("justknobx")._("515");return a+b}function b(a){var b=a.direction,e=a.includeReferenceExternalId,f=a.msgCount,g=a.referenceExternalId;a=a.sourceMsgs;if(!c("gkx")("7950"))return a;var k=j(a,b),l=d("MAWMessagesCompare").getSortComparisonFunctionForDirection(k);a=a.toSorted(l);l=a.findIndex(function(a){return a.externalId===g});if(b==="before"&&k==="desc"||b==="after"&&k==="asc"){l=h({includeReferenceExternalId:e,referenceMsgIndex:l});return a.slice(l,l+f)}else{l=i({includeReferenceExternalId:e,msgsCount:a.length,referenceMsgIndex:l});b=Math.max(0,l-f+1);return a.slice(b,l+1)}}function h(a){var b=a.includeReferenceExternalId;a=a.referenceMsgIndex;return a===-1?0:b?a:a+1}function i(a){var b=a.includeReferenceExternalId,c=a.msgsCount;a=a.referenceMsgIndex;return a===-1?c-1:b?a:a-1}function j(a,b){var c;c=(c=a.find(function(a){return a.sortOrderMs!=null}))==null?void 0:c.sortOrderMs;a=(a=a.findLast(function(a){return a.sortOrderMs!=null}))==null?void 0:a.sortOrderMs;return c==null||a==null?d("MAWMessagesDirection").translateMawDirectionToMwpDirection(b):c>=a?"desc":"asc"}g.overFetchEBMsgsIfNeeded=a;g.fixEBMessagesPagination=b}),98);
__d("MAWEBDeanonFetch",["EBAPI","FBLogger","MAWEBMsgsWithSameSortOrderFix","WAJids","WAResultOrError","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.chatJid,e=a.count,f=a.direction,g=a.includeReferenceTimestamp,h=a.referenceExternalId,i=a.referenceTimestampMs;a=a.sortFn;try{var j=d("MAWEBMsgsWithSameSortOrderFix").overFetchEBMsgsIfNeeded(e,h);j=(yield c("EBAPI").messageMetadataQuery({direction:f,includeAnonymizedMessages:!1,numberOfMessages:j,referenceTimestamp:i,threadId:d("WAJids").threadIdForChatJid(b)}));if(j.success===!1)return d("WAResultOrError").makeError("error",j.payload);b=j.value.messages;j=b.reduce(function(a,b){var c=b.offlineThreadingId;b=b.sortOrderMs;if(c==null||b==null)return a;b=Number(b);if(g!==!0&&b===i)return a;a.push({externalId:c,msgType:"unknown-deanon",sortOrderMs:b});return a},[]);b=d("MAWEBMsgsWithSameSortOrderFix").fixEBMessagesPagination({direction:f,includeReferenceExternalId:g,msgCount:e,referenceExternalId:h,sourceMsgs:j});f=a==null?b:b.sort(a);return d("WAResultOrError").makeResult(f)}catch(a){c("FBLogger")("messenger_web_missing_messages").catching(a).mustfix("Deanon GraphQL fails with error");return d("WAResultOrError").makeError("request-error",a.message)}});return h.apply(this,arguments)}g.fetchMessagesMetadataFromEBDeanon=a}),98);
__d("MAWFetchExternalIdUsingCache",["FBLogger","LSDatabaseSingleton","MAWBridgeSendAndReceive","MAWDbMsg","WAStanzaUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i=new Map();function a(a){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(a==="")return null;var b=m(a);if(b!=null)return b;b=(yield k(a));if(b!=null){n(a,b);return b}try{b=d("MAWDbMsg").toMsgId(a);if(b==null){c("FBLogger")("messenger_e2ee_web").warn("[MAWFetchProtocolMessageIdUsingCache] failed fetch external id, invalid msgId %s",a);return null}b=(yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","getProtocolMsgIdByMsgId",{msgId:b}));if((b==null?void 0:b.externalId)==null){c("FBLogger")("messenger_e2ee_web").warn("[MAWFetchProtocolMessageIdUsingCache] external id for msgId %s not found",a);return null}n(a,b.externalId);return b.externalId}catch(a){c("FBLogger")("messenger_e2ee_web").catching(a).mustfix("[MAWFetchProtocolMessageIdUsingCache] getProtocolMsgIdByMsgId bridge call failed");throw a}});return j.apply(this,arguments)}function k(a){return l.apply(this,arguments)}function l(){l=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=(yield (h||(h=d("LSDatabaseSingleton"))).LSDatabaseSingleton);b=(yield b.tables.messages.index("messageId").get(a));return b!=null?d("WAStanzaUtils").toStanzaId(b.offlineThreadingId):null});return l.apply(this,arguments)}function m(a){return i.get(a)}function n(a,b){if(a==="")return!1;i.set(a,b);return!0}g.fetchExternalIdUsingCache=a;g.populateExternalIdCache=n}),98);
__d("MAWFindMsgsWithMinAndMaxTimestamp",["MAWMessagesCompare","gkx"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){if(a.length===0)return[null,null];if(c("gkx")("7950"))return h(a,b);b=a.toSorted(function(a,b){return((a=a.sortOrderMs)!=null?a:0)-((a=b.sortOrderMs)!=null?a:0)});return[b[0],b[b.length-1]]}function b(a,b){a=a.filter(function(a){return a.sortOrderMs!=null});if(a.length===0)return[null,null];if(c("gkx")("7950"))return h(a,b);b=null;var d=null;for(var a=a,e=Array.isArray(a),f=0,a=e?a:a[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var g,i;if(e){if(f>=a.length)break;i=a[f++]}else{f=a.next();if(f.done)break;i=f.value}i=i;if(i.sortOrderMs==null)continue;(((g=b)==null?void 0:g.sortOrderMs)==null||b.sortOrderMs<i.sortOrderMs)&&(b=i);(((g=d)==null?void 0:g.sortOrderMs)==null||d.sortOrderMs>i.sortOrderMs)&&(d=i)}return[d,b]}function h(a,b){if(a.length===0)return[null,null];b=d("MAWMessagesCompare").getSortComparisonFunctionForDirection(b);a=a.filter(function(a){return a.sortOrderMs!=null}).sort(b);return[a[a.length-1],a[0]]}g.findEBMsgsWithMinAndMaxTimestamp=a;g.findMsgsWithMinAndMaxTimestamp=b}),98);
__d("MAWMessageIntegrityEBFetchStatus",[],(function(a,b,c,d,e,f){"use strict";var g=new Set();function a(a){return g.has(a)}function b(a){g.add(a)}f.hasEBFailure=a;f.recordEBFailure=b}),66);
__d("MAWMessagesPaginationUtils",["FBLogger","MAWFetchExternalIdUsingCache","MAWMessagesDirection","WAStanzaUtils","asyncToGeneratorRuntime","gkx"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){a=d("MAWMessagesDirection").getRangeMsgIdForDirection(a,b);return h(a)}function e(a){c("gkx")("7950")&&a.forEach(function(a){return d("MAWFetchExternalIdUsingCache").populateExternalIdCache(a.msgId.toString(),d("WAStanzaUtils").toStanzaId(a.externalId))})}function h(a){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(a==null||a==="")return null;if(!c("gkx")("7950"))return null;var b=(yield d("MAWFetchExternalIdUsingCache").fetchExternalIdUsingCache(a));b==null&&c("FBLogger")("messenger_e2ee_web").mustfix("[MAWMessagesPaginationUtils] getExternalIdByMsgId for msgId: %s returned null",a);return b});return i.apply(this,arguments)}g.getRangeExternalIdForDirection=a;g.populateExternalIdCache=e;g.getExternalIdByMsgId=h}),98);
__d("MAWMessagesRangesUtils",["I64","MAWFindMsgsWithMinAndMaxTimestamp","MAWMessagesDirection","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){return{hasMoreAfter:!1,hasMoreBefore:!1,isLoadingAfter:!1,isLoadingBefore:!1,maxMessageId:"",maxTimestampMs:(h||(h=d("I64"))).max_int,minMessageId:"",minTimestampMs:h.min_int,threadKey:a}}var i=c("gkx")("8338");function b(a){var b=a.direction,c=a.hasMoreMsgsInDeanon,e=a.mawFetchResult;a=a.range;var f=[].concat(e.msgs).sort(function(a,b){return a.sortOrderMs-b.sortOrderMs}),g=f.length>0?f[0]:void 0;f=f.length>0?f[f.length-1]:void 0;return d("MAWMessagesDirection").switchOnMWPMessagesDirection(b,{asc:babelHelpers["extends"]({},a,{hasMoreAfter:e.hasMoreAfter||i&&c,isLoadingAfter:!1,maxMessageId:(b=f==null?void 0:f.msgId)!=null?b:a.maxMessageId,maxTimestampMs:(h||(h=d("I64"))).max(a.maxTimestampMs,(f==null?void 0:f.sortOrderMs)!=null?(h||(h=d("I64"))).of_float(f==null?void 0:f.sortOrderMs):a.maxTimestampMs)}),desc:babelHelpers["extends"]({},a,{hasMoreBefore:e.hasMoreBefore||i&&c,isLoadingBefore:!1,minMessageId:(b=g==null?void 0:g.msgId)!=null?b:a.minMessageId,minTimestampMs:h.min(a.minTimestampMs,(g==null?void 0:g.sortOrderMs)!=null?(h||(h=d("I64"))).of_float(g==null?void 0:g.sortOrderMs):a.minTimestampMs)})})}function e(a,b,c){var e=d("MAWFindMsgsWithMinAndMaxTimestamp").findMsgsWithMinAndMaxTimestamp(b.msgs,c),f=e[0];e=e[1];e=babelHelpers["extends"]({},a,d("MAWMessagesDirection").switchOnMWPMessagesDirection(c,{asc:{hasMoreAfter:b.hasMoreAfter,isLoadingAfter:!1,maxMessageId:(c=e==null?void 0:e.msgId)!=null?c:a.maxMessageId,maxTimestampMs:(h||(h=d("I64"))).max(a.maxTimestampMs,(e==null?void 0:e.sortOrderMs)!=null?(h||(h=d("I64"))).of_float(e==null?void 0:e.sortOrderMs):a.maxTimestampMs)},desc:{hasMoreBefore:b.hasMoreBefore,isLoadingBefore:!1,minMessageId:(c=f==null?void 0:f.msgId)!=null?c:a.minMessageId,minTimestampMs:h.min(a.minTimestampMs,(f==null?void 0:f.sortOrderMs)!=null?(h||(h=d("I64"))).of_float(f==null?void 0:f.sortOrderMs):a.minTimestampMs)}}));return e}g.getRangeForFailure=a;g.IS_RANGE_FIX_ENABLED=i;g.getNewMAWRange=b;g.mergeMoreMessagesResponseIntoRange=e}),98);
__d("MAWPutMessagesToDB",["MAWBridgeDeleteReactionHandler","MAWBridgeMsgsStartCountdownHandler","MAWBridgeNewMediaHandler","MAWBridgeNewMsgHandler","MAWBridgeNewReceiverFetchInfoHandler","MAWBridgeNewXMAHandler","MAWBridgeReactionUpsertHandler","MAWDataSourceLogger","MAWGetIsMediaDownloadStatusEnabled","Promise","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a,b,c,d){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,e,f){var g=c.expiringCountdown,i=c.medias,j=c.msgs,k=c.reactions,l=c.receiverFetchInfoPayloads;c=c.xmas;f!=null&&d("MAWDataSourceLogger").logDispatchDownloadStateUpdatesStart(f);d("MAWGetIsMediaDownloadStatusEnabled").getIsMediaDownloadStatusEnabled()&&e({tag:"NewMedias",value:i});d("MAWGetIsMediaDownloadStatusEnabled").getIsMediaDownloadStatusForXMAsEnabled()&&e({tag:"NewXMAs",value:c});f!=null&&(d("MAWDataSourceLogger").logDispatchDownloadStateUpdatesEnd(f),d("MAWDataSourceLogger").logCallBridgeHandlersStart(f));yield d("MAWBridgeNewMsgHandler").bulkCall(a,j);yield (h||(h=b("Promise"))).all(i.map(function(b){return d("MAWBridgeNewMediaHandler").call(a,b)}));yield h.all(c.map(function(b){return d("MAWBridgeNewXMAHandler").call(a,b)}));yield h.all(l.map(function(b){return d("MAWBridgeNewReceiverFetchInfoHandler").call(a,b)}));yield d("MAWBridgeMsgsStartCountdownHandler").call(a,{msgs:g});yield h.all(k.map(function(b){return b.type==="delete"?d("MAWBridgeDeleteReactionHandler").call(a,b.reaction):d("MAWBridgeReactionUpsertHandler").call(a,b.reaction)}));f!=null&&d("MAWDataSourceLogger").logCallBridgeHandlersEnd(f)});return j.apply(this,arguments)}function a(a,b,c,d){return a.runInTransaction(function(a){return i(a,b,c,d)},"readwrite","ui",void 0,f.id+":104")}function c(a,b,c){return a.runInTransaction(function(a){return i(a,babelHelpers["extends"]({},b,{expiringCountdown:[],hasMoreAfter:!1,hasMoreBefore:!1}),c)},"readwrite","ui",void 0,f.id+":123")}g.insertMessageResponseToDBInExistingTransaction=i;g.insertMessageResponseIntoDatabase=a;g.insertMessageResponseIntoDatabaseByExternalId=c}),98);
__d("MAWSecureLocalDBFetch",["CometLruCache","FBLogger","I64","MAWBridgeSendAndReceive","MAWDbMsg","WAResultOrError","asyncToGeneratorRuntime","deepEquals","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h,i=d("CometLruCache").create(20,2e3);function a(a,b){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var e=a.chatJid,f=a.config,g=a.count,h=a.direction,j=a.offsetMsg,l=a.timestampMs;e=i.get(e);if(e!=null){var n=e&&e.options,o=n.count;n=babelHelpers.objectWithoutPropertiesLoose(n,["count"]);if(c("deepEquals")(n,{config:f,direction:h,offsetMsg:j,timestampMs:l})&&g<=o)try{return d("WAResultOrError").makeResult(babelHelpers["extends"]({},yield e.result))}catch(a){}}if(c("gkx")("7950"))return m(a,b);else return k(a,b)});return j.apply(this,arguments)}function k(a,b){return l.apply(this,arguments)}function l(){l=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var e=a.actionType,f=a.chatJid,g=a.config,j=a.count,k=a.direction,l=a.offsetMsg;a=a.timestampMs;try{e=d("MAWBridgeSendAndReceive").sendAndReceive("backend","maw_load_msgs",{actionType:e,chatJid:f,config:g,direction:k,includeOriginalMsg:(e=l==null?void 0:l.includeOriginalMsg)!=null?e:!1,msgId:(l==null?void 0:l.messageId)==null?null:d("MAWDbMsg").toMsgId(l.messageId),numMsgs:j,sortOrderMs:a!=null?(h||(h=d("I64"))).to_float(a):null},{timeoutMs:b==null?void 0:b.timeoutMs});i.set(f,{options:{config:g,count:j,direction:k,offsetMsg:l,timestampMs:a},result:e});b=babelHelpers["extends"]({},yield e);return d("WAResultOrError").makeResult(b)}catch(a){c("FBLogger")("messenger_e2ee_web").catching(a).mustfix("[MAWSecureLocalDBFetch] maw_load_msgs bridge call failed");return d("WAResultOrError").makeError("bridge_call_failed",a)}});return l.apply(this,arguments)}function m(a,b){return n.apply(this,arguments)}function n(){n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var e=a.actionType,f=a.chatJid,g=a.config,j=a.count,k=a.direction,l=a.offsetMsg;a=a.timestampMs;try{e=d("MAWBridgeSendAndReceive").sendAndReceive("backend","maw_load_msgs_range",{actionType:e,chatJid:f,config:g,direction:k,range:{includeLowerBoundMsg:(e=l==null?void 0:l.includeOriginalMsg)!=null?e:!1,lowerBoundExternalId:(l==null?void 0:l.externalId)==null?void 0:l.externalId,lowerBoundSortOrderMs:a!=null?(h||(h=d("I64"))).to_float(a):void 0,numMsgs:j}},{timeoutMs:b==null?void 0:b.timeoutMs});i.set(f,{options:{config:g,count:j,direction:k,offsetMsg:l,timestampMs:a},result:e});b=babelHelpers["extends"]({},yield e);return d("WAResultOrError").makeResult(b)}catch(a){c("FBLogger")("messenger_e2ee_web").catching(a).mustfix("[MAWSecureLocalDBFetch] maw_load_msgs bridge call failed");return d("WAResultOrError").makeError("bridge_call_failed",a)}});return n.apply(this,arguments)}g["default"]=a}),98);
__d("MLV2DataSourceLogger",["I64","MAWQPLLogger","interaction-tracing","justknobx","mergeDeep","performanceNow","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(){j==null&&(j=c("MAWQPLLogger")(c("qpl")._(25303796,"1974")));return j}var l=new Map();function m(a,b){return(i||(i=d("I64"))).to_string(a)+b}function a(a,b,e,f){var g=m(a,b),j=l.get(g);if(j!=null)if(c("justknobx")._("3341"))j.markQPLCancel("restart_logger");else return j;var n=k().markQPLStart(),o=c("interaction-tracing").InteractionTracingCore.getPendingInteractions(),p=(h||(h=c("performanceNow")))(),q=function(a,b){var d=(h||(h=c("performanceNow")))(),e={action:a,full_duration:(d-p)/1e3};b!=null&&(e=c("mergeDeep")(e,b));o.forEach(function(a){a.addSubspan("MLV2_fetch","AppTiming",p,d,e)})},r=new Set();j={addQPLAnnotations:function(a){k().addQPLAnnotations(n,a)},annotateMessageRangesDataSource:function(a){r.add(a),k().addQPLAnnotations(n,{string_array:{message_ranges_source:Array.from(r.keys())}})},getInstanceKey:function(){return n},markQPLCancel:function(a){k().addQPLAnnotations(n,{string:{cancel_reason:a}}),k().markQPLCancel(n),q("CANCEL"),l["delete"](g)},markQPLFailure:function(a){k().markQPLFailure(n,a),q("FAIL"),l["delete"](g)},markQPLFailureWithMsg:function(a){k().markQPLFailureWithMsg(n,a),q("FAIL"),l["delete"](g)},markQPLPoint:function(a){k().markQPLPoint(n,a)},markQPLSuccess:function(a){k().markQPLSuccess(n),q("SUCCESS",{num_msgs_fetched:a}),l["delete"](g)}};j.addQPLAnnotations({"int":{queried_count:e},string:{direction:b,thread_id:(i||(i=d("I64"))).to_string(a),thread_type:i.to_string(f)}});l.set(g,j);return j}function b(a,b){a=m(a,b);return l.get(a)}g.startMLV2LoggerForThread=a;g.getMLV2LoggerForThread=b}),98);
__d("MAWSecureLocalDBDataSource",["I64","MAWBridgeSendAndReceive","MAWDataSourceLogger","MAWDbMsg","MAWIsEBEnabled","MAWMessagesPaginationUtils","MAWMiActOnActThreadReady","MAWPutMessagesToDB","MAWSecureDataSource","MAWSecureLocalDBFetch","MLV2DataSourceLogger","Promise","ReQL","WAStanzaUtils","WATagsLogger","asyncToGeneratorRuntime","err","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Fetching "," messages by external id, which is not optimal.\n      Consider migrating 'loadMsgsByExternalId' backend request to a batch version "]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to fetch messages: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["useFetchSecureMessages: threadJid: "," minMsgSortOrderTsResponse ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Fetch more: ",""]);m=function(){return a};return a}var n=c("requireDeferred")("MAWEBFetch").__setRef("MAWSecureLocalDBDataSource"),o=d("WATagsLogger").TAGS(["MAWSecureLocalDBDataSource"]);function p(a){return a.msgs.map(function(a){return{externalId:a.externalId,isOutgoing:a.isAuthorMe,msgType:a.type_,sortOrderMs:a.sortOrderMs}})}a=function(){function a(){this.$1=!1}var e=a.prototype;e.$2=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,g,h,j,k,p,q,r){if(j==="after")return;j;o.LOG(m(),e);d("MAWDataSourceLogger").logLoadMoreMsgsThreadWaiting(p,"before",e);j=(yield d("MAWMiActOnActThreadReady").waitForACTThreadReady(a.tables,e,"MAWFetchMoreMessages"));j=j.chatJid;d("MAWDataSourceLogger").logLoadMoreMsgsThreadReadyFetchMsgs(p);d("MAWDataSourceLogger").logLoadMessagesFromLocalDBStart(p);var s=h.minMessageId,t=(yield d("MAWMessagesPaginationUtils").getExternalIdByMsgId(s));q=(yield c("MAWSecureLocalDBFetch")({actionType:q,chatJid:j,config:{admin:!0,editMsgHistory:!0,media:!0,reactions:!0,receiverFetch:!0,xma:!0},count:k,direction:"before",offsetMsg:{externalId:t,includeOriginalMsg:!1,messageId:s},timestampMs:g}));if(q.success===!1){throw(t=q.payload)!=null?t:c("err")(q.error)}var u=q.value;d("MAWDataSourceLogger").logLoadMessagesFromLocalDBEnd(p);d("MAWDataSourceLogger").logInsertMessageResponseToLSDBStart(p);d("MAWMessagesPaginationUtils").populateExternalIdCache(u.msgs);var v=u.msgs.length>0?u.msgs[u.msgs.length-1].msgId:h.minMessageId;yield a.runInTransaction(function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var c;yield d("MAWPutMessagesToDB").insertMessageResponseToDBInExistingTransaction(b,u,r,p);c=(yield (c=b.messages_ranges_v2__generated).get.apply(c,[h.threadKey,h.minTimestampMs,h.minMessageId]));if(c==null)return;var e=u.hasMoreBefore;u.hasMoreBefore===!1&&(yield d("MAWIsEBEnabled").isEbEnabled(a))&&(e=!0);yield b.messages_ranges_v2__generated.upsert([c.threadKey,c.minTimestampMs,c.minMessageId],{hasMoreAfter:!1,hasMoreBefore:e,isLoadingAfter:!1,isLoadingBefore:!1,maxMessageId:c.maxMessageId,maxTimestampMs:c.maxTimestampMs,minMessageId:v,minTimestampMs:(i||(i=d("I64"))).zero,threadKey:h.threadKey})});return function(a){return c.apply(this,arguments)}}(),"readwrite","ui",void 0,f.id+":145");d("MAWDataSourceLogger").logInsertMessageResponseToLSDBEnd(p);d("MAWDataSourceLogger").logLoadMoreMsgsFetched(p,u.hasMoreBefore);if(u.hasMoreBefore){d("MAWDataSourceLogger").logLoadMoreMsgsSuccess(p);return}s=(yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","getMaybeNextNonAdminMsgSortOrderMs",{chatJid:j,mayBeAdminMsgId:d("MAWDbMsg").toMsgId(h.minMessageId)}));d("WATagsLogger").TAGS(["labyrinth_web","useFetchSecureMessages"]).LOG(l(),j,s.minMsgTimestampMs);d("MAWDataSourceLogger").logLoadMoreMsgsRangeQuery(p,s.minMsgTimestampMs);g=(yield n.load());t=(yield g({chatJid:j,count:k,db:a,direction:"before",timestampMs:(i||(i=d("I64"))).of_float(s.minMsgTimestampMs)}));t.success&&t.value.hasMoreBefore===!1&&(yield a.runInTransaction(function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var c=h.minTimestampMs,f=(yield d("ReQL").firstAsync(d("ReQL").fromTableDescending(a.tables.messages_ranges_v2__generated).getKeyRange(e).bounds({lte:[c]}).filter(function(a){var b=a.maxTimestampMs;a=a.minTimestampMs;return(i||(i=d("I64"))).ge(c,a)&&(i||(i=d("I64"))).le(c,b)})));if(f==null)return;yield b.messages_ranges_v2__generated.upsert([f.threadKey,f.minTimestampMs,f.minMessageId],babelHelpers["extends"]({},f,{hasMoreBefore:!1,isLoadingBefore:!1}))});return function(a){return c.apply(this,arguments)}}(),"readwrite","ui",void 0,f.id+":229"));d("MAWDataSourceLogger").logLoadMoreMsgsSuccess(p)});function e(b,c,d,e,f,g,h,i,j){return a.apply(this,arguments)}return e}();e.requestMessages=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,h,i,j){a=(yield d("MAWMessagesPaginationUtils").getExternalIdByMsgId(f));b=(yield c("MAWSecureLocalDBFetch")({actionType:j,chatJid:b,config:i,count:(j=h)!=null?j:d("MAWSecureDataSource").DEFAULT_NUM_MESSAGES,direction:g,offsetMsg:f==null?null:{externalId:a,includeOriginalMsg:!1,messageId:f},timestampMs:e}));if(b.success===!1){throw(i=b.payload)!=null?i:c("err")(b.error)}h=b.value;d("MAWMessagesPaginationUtils").populateExternalIdCache(h.msgs);j=h.msgs.map(function(a){return{externalId:a.externalId,isOutgoing:a.isAuthorMe,msgType:a.type_,sortOrderMs:a.sortOrderMs}});return{hasMoreAfter:h.hasMoreAfter,hasMoreBefore:h.hasMoreBefore,msgs:j}});function e(b,c,d,e,f,g,h,i){return a.apply(this,arguments)}return e}();e.fetchSecureMessagesProtocol=function(a,b,c,e,f,g,h,i,j){h===void 0&&(h=d("MAWSecureDataSource").DEFAULT_NUM_MESSAGES);c=d("MAWDataSourceLogger").logLoadMoreMsgsStart(c);return this.$2(a,b,e,f,g,h,c,i,j)["catch"](function(a){var c;o.ERROR(k(),a);(c=d("MLV2DataSourceLogger").getMLV2LoggerForThread(b,g))==null?void 0:c.markQPLFailure(a)})};e.fetchMessagesByExternalId=function(a,c){a.length>2&&o.WARN(j(),a.length);a=a.map(function(a){return d("MAWBridgeSendAndReceive").sendAndReceive("backend","loadMsgsByExternalId",{config:c,externalId:d("WAStanzaUtils").toStanzaId(a)})});return(h||(h=b("Promise"))).all(a).then(function(a){return a.map(function(a){return p(a)}).flat()})};e.getMessagesCount=function(a,b,c,e,f){return d("MAWBridgeSendAndReceive").sendAndReceive("backend","getMsgsCount",{chatJid:a,direction:e,maxNumMsgs:c,offsetMsgId:d("MAWDbMsg").toMsgId(b),sortOrderMsLimit:f}).then(function(a){return babelHelpers["extends"]({},a)})};return a}();g["default"]=a}),98);